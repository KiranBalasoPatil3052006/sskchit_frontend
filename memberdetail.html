<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Seetu App - Member Detail</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="images/sskicon.png">

    <style>
        /* ðŸ”’ UI STYLES â€” UNCHANGED */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        :root {
            --bg: #f5efe6;
            --bg-gradient: linear-gradient(135deg, #fdf3e7, #f7e4cf);
            --text: #3a251b;
            --accent: #d2b89b;
            --card-bg: #fff7ee
        }

        body {
            font-family: system-ui;
            background: var(--bg-gradient);
            color: var(--text)
        }

        .navbar {
            background: #f5efe6;
            padding: 10px 16px;
            border-bottom: 1px solid #d2b89b
        }

        .brand {
            font-weight: 800
        }

        .page {
            max-width: 1100px;
            margin: auto;
            padding: 16px
        }

        .profile-card {
            background: radial-gradient(circle, #fff9f2, #f7e4cf);
            border-radius: 16px;
            padding: 18px;
            text-align: center
        }

        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid #d2b89b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin: auto
        }

        .amount-chip {
            margin: 6px auto;
            padding: 4px 10px;
            border-radius: 999px;
            background: #fff
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(6, 120px);
            gap: 8px
        }

        .week-cell {
            height: 56px;
            border: 1px solid #d2b89b;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center
        }

        .week-cell.paid {
            background: #ffeedf
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .4);
            display: none;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.open {
            display: flex
        }

        .modal {
            background: #fff;
            padding: 16px;
            border-radius: 12px;
            width: 90%;
            max-width: 380px
        }

        .btn {
            border-radius: 999px;
            padding: 6px 12px;
            font-weight: 600;
            cursor: pointer
        }

        .btn-primary {
            background: #ffe0d5;
            border: 1px solid #d2b89b
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #aaa
        }
    </style>
</head>

<body>

    <div class="navbar">
        <div class="brand">SSK Chit Funds</div>
    </div>

    <main class="page">

        <section class="profile-card">
            <div class="avatar" id="avatar">M</div>
            <h2 id="memberName">Member</h2>
            <div id="memberStatus">Weekly Member</div>
            <div class="amount-chip" id="amountChip">â‚¹0 / week</div>

            <button class="btn btn-primary" id="shareReceipt">Download / Share Receipt</button>
        </section>

        <section style="margin-top:20px">
            <div class="week-grid" id="weekGrid"></div>

            <div style="margin-top:12px">
                <strong>Weeks Paid:</strong> <span id="paidWeeks">0</span><br>
                <strong>Weeks Pending:</strong> <span id="pendingWeeks">0</span><br>
                <strong>Total Paid:</strong> â‚¹<span id="paidAmount">0</span><br>
                <strong>Remaining:</strong> â‚¹<span id="pendingAmount">0</span>
            </div>
        </section>

    </main>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3 id="modalTitle">Confirm</h3>
            <p id="modalText"></p>
            <div style="text-align:right">
                <button class="btn btn-outline" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        /* =========================
           FINAL WORKING SCRIPT
        ========================= */

        const API = "https://sskchitbackend-production.up.railway.app/api";
        const TOTAL_WEEKS = 52;

        const grid = document.getElementById("weekGrid");
        const modal = document.getElementById("modal");
        const modalText = document.getElementById("modalText");
        const confirmBtn = document.getElementById("confirmBtn");
        const cancelBtn = document.getElementById("cancelBtn");

        let member = null;
        let selectedWeek = null;

        const id = new URLSearchParams(location.search).get("id");
        const token = localStorage.getItem("token");

        const normalize = a => Array(TOTAL_WEEKS).fill(false).map((_, i) => !!a?.[i]);

        async function loadMember() {
            const r = await fetch(`${API}/members/${id}`);
            member = await r.json();
            member.paidWeeks = normalize(member.paidWeeks);
            render();
        }

        function render() {
            document.getElementById("avatar").textContent = member.name[0];
            document.getElementById("memberName").textContent = member.name;
            document.getElementById("amountChip").textContent = `â‚¹${member.amount}/week`;

            grid.innerHTML = "";
            member.paidWeeks.forEach((p, i) => {
                const c = document.createElement("div");
                c.className = "week-cell" + (p ? " paid" : "");
                c.innerHTML = `<div>W ${i + 1}</div><div>${p ? "PAID" : "-"}</div>`;
                c.onclick = () => openConfirm(i);
                grid.appendChild(c);
            });

            const paid = member.paidWeeks.filter(Boolean).length;
            document.getElementById("paidWeeks").textContent = paid;
            document.getElementById("pendingWeeks").textContent = TOTAL_WEEKS - paid;
            document.getElementById("paidAmount").textContent = paid * member.amount;
            document.getElementById("pendingAmount").textContent = (TOTAL_WEEKS - paid) * member.amount;
        }

        function openConfirm(i) {
            selectedWeek = i;
            modalText.innerHTML = member.paidWeeks[i]
                ? "Cancel this PAID week?"
                : "Confirm payment?";
            modal.classList.add("open");
        }

        confirmBtn.onclick = async () => {
            member.paidWeeks[selectedWeek] = !member.paidWeeks[selectedWeek];
            await fetch(`${API}/members/${id}`, {
                method: "PUT",
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ paidWeeks: member.paidWeeks })
            });
            modal.classList.remove("open");
            render();
        }

        cancelBtn.onclick = () => modal.classList.remove("open");

        document.getElementById("shareReceipt").onclick = () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            pdf.text(`SSK Chit Funds Receipt`, 20, 20);
            pdf.text(`Member: ${member.name}`, 20, 35);
            pdf.text(`Total Paid: â‚¹${member.paidWeeks.filter(Boolean).length * member.amount}`, 20, 45);
            pdf.text(`Owner Signature: __________`, 20, 70);
            pdf.save(`Receipt_${member.name}.pdf`);
        };

        loadMember();
    </script>

</body>

</html>
