<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Member Detail - Seetu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent:#0b5;
      --danger:#c33;
      --muted:#666;
      --bg:#f4f6f8;
      --card:#fff;
    }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; margin:0; background:var(--bg); color:#222; }
    header { background:var(--accent); padding:12px 16px; display:flex; justify-content:space-between; align-items:center; color:#fff; }
    .brand { font-weight:700; }
    nav { display:flex; gap:12px; align-items:center; }
    nav a { color:#fff; text-decoration:none; padding:6px 8px; border-radius:6px; }
    main { padding:18px; max-width:1100px; margin:0 auto; }

    .headerbox { display:flex; flex-wrap:wrap; gap:12px; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
    .summary { background:var(--card); padding:12px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,.05); min-width:220px; flex:1 1 420px; }
    .controls { display:flex; gap:8px; flex-direction:column; align-items:flex-end; }
    .controls .row { display:flex; gap:8px; }
    .btn { padding:8px 12px; border-radius:6px; background:var(--accent); color:#fff; border:0; cursor:pointer; }
    .btn.danger { background:var(--danger); }
    .muted { color:var(--muted); font-size:0.95rem; }

    /* Grid: force 52 cells by using 13 columns => 4 rows (13*4=52) */
    .weeks-wrap { margin-top:14px; background:transparent; }
    .legend { display:flex; gap:12px; align-items:center; margin-bottom:8px; }
    .legend .chip { display:inline-flex; gap:8px; align-items:center; font-size:0.95rem; }
    .legend .sw { width:18px; height:18px; border-radius:4px; display:inline-block; }

    .week-grid {
      display:grid;
      grid-template-columns: repeat(13, minmax(44px,1fr)); /* 13 cols => 52 cells = 4 rows */
      gap:8px;
      padding:8px;
      background:transparent;
    }
    .week {
      background:var(--card);
      padding:8px;
      border-radius:6px;
      text-align:center;
      box-shadow:0 1px 3px rgba(0,0,0,.04);
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, box-shadow .12s ease;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
    }
    .week:hover { transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,.08); }
    .week.paid { background:#dff0d8; color:#2b6b2b; }
    .week.unpaid { background:var(--card); color:#222; opacity:0.98; }

    /* responsive: fewer columns on small screens */
    @media(max-width:1100px){
      .week-grid { grid-template-columns: repeat(11, minmax(40px,1fr)); }
    }
    @media(max-width:920px){
      .week-grid { grid-template-columns: repeat(8, minmax(40px,1fr)); }
    }
    @media(max-width:640px){
      .week-grid { grid-template-columns: repeat(6, minmax(40px,1fr)); gap:6px; }
    }
    @media(max-width:420px){
      .week-grid { grid-template-columns: repeat(4, minmax(40px,1fr)); }
    }

    /* ensure grid scrolls if too tall */
    .grid-container {
      max-height: 62vh;
      overflow:auto;
      padding-right:6px;
    }

    /* modal */
    .modal-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:40; }
    .modal-overlay.open { display:flex; }
    .modal { background:#fff; padding:18px; border-radius:8px; width:360px; max-width:95%; }

    /* small helpers */
    .note { font-size:0.9rem; color:#444; margin-top:6px; }
    .loading { padding:30px; text-align:center; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="brand">Seetu</div>
    <nav>
      <a href="home.html">Home</a>
      <a href="members.html">Members</a>
      <a href="index.html">Login</a>
    </nav>
  </header>

  <main>
    <div class="headerbox">
      <div class="summary" id="memberHeader">
        <h2 id="memberName">Loading…</h2>
        <div class="muted" id="memberMeta">Please wait while we fetch member details</div>
        <div class="note" style="margin-top:8px;">
          <strong>Amount:</strong> <span id="memberAmount">-</span><br>
          <strong>Status:</strong> <span id="memberStatus">-</span>
        </div>
      </div>

      <div class="controls">
        <div class="row">
          <button class="btn" id="refreshBtn">Refresh</button>
          <button class="btn danger" id="cancelPlanBtn">Remove</button>
        </div>
        <div class="muted" style="font-size:0.85rem;margin-top:6px;">Click a cell to toggle paid</div>
      </div>
    </div>

    <section class="weeks-wrap">
      <div class="legend">
        <div class="chip"><span class="sw" style="background:#dff0d8;border:1px solid rgba(0,0,0,.03)"></span> Paid</div>
        <div class="chip"><span class="sw" style="background:#fff;border:1px solid #eee"></span> Unpaid</div>
        <div style="margin-left:auto" class="muted">52 Weeks · Optimistic update</div>
      </div>

      <div class="grid-container">
        <div id="weekGrid" class="week-grid" aria-live="polite">
          <!-- 52 cells injected here -->
        </div>
      </div>
    </section>
  </main>

  <!-- Toggle confirm modal (kept but we use optimistic update so it's optional) -->
  <div class="modal-overlay" id="toggleModal">
    <div class="modal">
      <h3 id="modalTitle">Confirm</h3>
      <p id="modalBody">Toggle this week?</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button class="btn secondary" id="btnCancel">Cancel</button>
        <button class="btn" id="btnConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = 'https://sskchitbackend.onrender.com/api';
    const TOTAL_WEEKS = 52;

    // ====== STATE ======
    let currentMember = null;
    let pendingUpdate = false; // to avoid concurrent PUTs
    let lastRenderedPaid = null;

    // ====== HELPERS ======
    function getToken() { return localStorage.getItem('token') || null; }
    function getMemberIdFromUrl() {
      const p = new URLSearchParams(window.location.search);
      return p.get('id');
    }

    function normalizePaidWeeks(arr){
      if (!Array.isArray(arr)) return Array(TOTAL_WEEKS).fill(false);
      if (arr.length === TOTAL_WEEKS) return arr.map(Boolean);
      const normalized = Array(TOTAL_WEEKS).fill(false);
      for (let i=0;i<Math.min(arr.length, TOTAL_WEEKS); i++) normalized[i] = !!arr[i];
      return normalized;
    }

    async function apiGetMember(id){
      try {
        const res = await fetch(`${API_BASE}/members/${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error('Member fetch failed');
        return await res.json();
      } catch(e){
        console.error(e);
        return null;
      }
    }

    async function apiUpdateMember(id, updates){
      const token = getToken();
      if (!token) throw new Error('Login required');
      const res = await fetch(`${API_BASE}/members/${encodeURIComponent(id)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(updates)
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error(txt || 'Update failed');
      }
      return res.json();
    }

    async function apiDeleteMember(id){
      const token = getToken();
      if (!token) throw new Error('Login required');
      const res = await fetch(`${API_BASE}/members/${encodeURIComponent(id)}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error(txt || 'Delete failed');
      }
      return res.json();
    }

    // ====== UI REFS ======
    const memberNameEl = document.getElementById('memberName');
    const memberMetaEl = document.getElementById('memberMeta');
    const memberAmountEl = document.getElementById('memberAmount');
    const memberStatusEl = document.getElementById('memberStatus');
    const weekGrid = document.getElementById('weekGrid');
    const refreshBtn = document.getElementById('refreshBtn');
    const cancelPlanBtn = document.getElementById('cancelPlanBtn');

    // modal elements (not required for optimistic update)
    const toggleModal = document.getElementById('toggleModal');
    const btnCancel = document.getElementById('btnCancel');
    const btnConfirm = document.getElementById('btnConfirm');

    // ====== RENDER ======
    function renderHeader(){
      if (!currentMember) {
        memberNameEl.textContent = 'Member not found';
        memberMetaEl.textContent = '';
        memberAmountEl.textContent = '-';
        memberStatusEl.textContent = '-';
        return;
      }
      memberNameEl.textContent = currentMember.name || '—';
      memberMetaEl.textContent = `ID: ${currentMember.id || '—'}`;
      memberAmountEl.textContent = `₹${Number(currentMember.amount || 0)} / week`;
      memberStatusEl.textContent = currentMember.status || '-';
    }

    function renderWeekGrid(){
      // ensure we always render 52 cells
      weekGrid.innerHTML = '';
      const arr = normalizePaidWeeks(currentMember.paidWeeks);
      lastRenderedPaid = arr.slice(); // copy
      for (let i=0;i<TOTAL_WEEKS;i++){
        const cell = document.createElement('div');
        cell.className = 'week ' + (arr[i] ? 'paid' : 'unpaid');
        cell.setAttribute('data-week', String(i));
        cell.setAttribute('role','button');
        cell.setAttribute('aria-pressed', String(!!arr[i]));
        cell.title = `Week ${i+1} — ${arr[i] ? 'paid' : 'unpaid'}`;
        cell.textContent = i+1;

        // click handler -> optimistic toggle then persist
        cell.addEventListener('click', async (ev) => {
          ev.preventDefault();
          if (pendingUpdate) {
            // small safeguard to avoid multiple concurrent PUTs
            console.warn('Update in progress, wait.');
            return;
          }
          const idx = Number(cell.getAttribute('data-week'));
          // toggle locally (optimistic)
          arr[idx] = !arr[idx];
          currentMember.paidWeeks = arr.slice();
          updateCellUI(cell, arr[idx]);

          // persist in background
          pendingUpdate = true;
          try {
            const id = getMemberIdFromUrl();
            if (!id) throw new Error('Missing member id — login maybe required.');
            // send the full array (server expects paidWeeks array)
            const res = await apiUpdateMember(id, { paidWeeks: currentMember.paidWeeks });
            // apply server response if provided (keeps in sync)
            if (res && Array.isArray(res.paidWeeks)) {
              currentMember.paidWeeks = normalizePaidWeeks(res.paidWeeks);
              // re-render grid to ensure exact server truth
              renderWeekGrid();
            } else {
              // server didn't return updated paidWeeks — keep optimistic state
              // but ensure aria attributes are correct
              cell.setAttribute('aria-pressed', String(!!arr[idx]));
            }
          } catch (err) {
            console.error('Persist failed', err);
            // revert optimistic change
            arr[idx] = !arr[idx];
            currentMember.paidWeeks = arr.slice();
            // update the single cell visually (search by data-week)
            const target = weekGrid.querySelector(`.week[data-week="${idx}"]`);
            if (target) updateCellUI(target, arr[idx]);
            alert('Could not save change: ' + (err.message || 'Server error'));
          } finally {
            pendingUpdate = false;
          }
        });

        weekGrid.appendChild(cell);
      }
    }

    function updateCellUI(cellEl, isPaid){
      cellEl.classList.toggle('paid', !!isPaid);
      cellEl.classList.toggle('unpaid', !isPaid);
      cellEl.setAttribute('aria-pressed', String(!!isPaid));
      cellEl.title = `Week ${cellEl.textContent} — ${isPaid ? 'paid' : 'unpaid'}`;
    }

    // ====== CONTROLS ======
    refreshBtn.addEventListener('click', init);
    cancelPlanBtn.addEventListener('click', async () => {
      if (!confirm('Remove this member? This will delete the member.')) return;
      try {
        const id = getMemberIdFromUrl();
        await apiDeleteMember(id);
        alert('Member removed');
        window.location.href = 'members.html';
      } catch (err) {
        console.error(err);
        if ((err.message||'').toLowerCase().includes('login')) {
          if (confirm('Login required. Go to login?')) window.location.href = 'index.html';
        } else {
          alert('Could not remove member: ' + (err.message || 'server error'));
        }
      }
    });

    // ====== INIT ======
    async function init(){
      const id = getMemberIdFromUrl();
      if (!id) {
        alert('No member id provided in URL.');
        window.location.href = 'members.html';
        return;
      }

      // show loading
      memberNameEl.textContent = 'Loading…';
      memberMetaEl.textContent = '';
      memberAmountEl.textContent = '-';
      memberStatusEl.textContent = '-';
      weekGrid.innerHTML = `<div class="loading">Loading weeks…</div>`;

      const m = await apiGetMember(id);
      if (!m) {
        alert('Member not found or server error. Returning to members list.');
        window.location.href = 'members.html';
        return;
      }

      // normalize paidWeeks to exactly 52 booleans
      m.paidWeeks = normalizePaidWeeks(m.paidWeeks);
      currentMember = m;

      renderHeader();
      renderWeekGrid();

      // if returned paidWeeks length wasn't 52 (server older data) attempt to persist normalized array
      try {
        if (getToken() && (!Array.isArray(m.paidWeeks) || m.paidWeeks.length !== TOTAL_WEEKS)) {
          await apiUpdateMember(id, { paidWeeks: currentMember.paidWeeks });
        }
      } catch (e) {
        // non-fatal; UI already shows normalized state; just warn
        console.warn('Could not persist normalized paidWeeks (non-fatal)', e);
      }
    }

    // initial load
    init();
  </script>
</body>
</html>
